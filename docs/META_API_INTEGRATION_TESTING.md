# Meta API統合テストガイド

本番環境へのデプロイ前に、実際のMeta APIを使用して統合テストを実施します。

## 前提条件

1. Meta開発者アカウントとアプリの作成が完了していること
2. 必要な環境変数が設定されていること
3. テスト用の広告アカウントへのアクセス権限があること

## テスト手順

### 1. 環境変数の確認

`.env.local`ファイルに以下が設定されていることを確認：

```env
VITE_META_APP_ID=your_actual_app_id
VITE_META_APP_SECRET=your_actual_app_secret
VITE_META_AD_ACCOUNT_ID=act_your_test_account_id
VITE_USE_MOCK_DATA=false
```

### 2. アクセストークンの取得

1. http://localhost:3000/meta-api-setup にアクセス
2. 「トークン設定」タブを選択
3. 「開発用短期トークンを取得」ボタンをクリック
4. Facebook認証を完了
5. 取得したトークンを環境変数に追加：
   ```env
   VITE_META_ACCESS_TOKEN=your_access_token
   ```

### 3. API接続テスト

統合テストスクリプトを実行してAPI接続をテスト：

```bash
npm run test:meta-api
```

このスクリプトは以下のテストを自動的に実行します：

- 環境変数チェック
- API接続確認
- 広告アカウント情報取得
- キャンペーン一覧取得
- インサイトデータ取得
- トークン検証（App Secretがある場合）
- レート制限状態確認
- バッチリクエスト
- エラーハンドリング

### 4. 手動テストチェックリスト

#### A. 基本的なAPI呼び出し

- [ ] アカウント情報の取得
  - http://localhost:3000/meta-api-setup で「接続テスト」を実行
  - アカウント名とIDが表示されることを確認

- [ ] キャンペーン一覧の取得
  - http://localhost:3000/meta-dashboard にアクセス
  - キャンペーン一覧が表示されることを確認

- [ ] インサイトデータの取得
  - ダッシュボードで主要指標（広告費用、インプレッション等）が表示されることを確認

#### B. エラーハンドリング

- [ ] 無効なトークンエラー
  - 環境変数のトークンを無効な値に変更
  - エラーメッセージが適切に表示されることを確認

- [ ] レート制限エラー
  - 短時間に大量のリクエストを送信
  - レート制限メッセージが表示されることを確認

- [ ] ネットワークエラー
  - インターネット接続を切断
  - オフラインメッセージが表示されることを確認

#### C. トークン管理

- [ ] トークンの自動更新
  - 長期トークンへの交換が成功することを確認
  - トークン情報がlocalStorageに保存されることを確認

- [ ] トークンの有効期限確認
  - トークン管理UIで有効期限が表示されることを確認

#### D. データ同期

- [ ] 初回データ同期
  - 「データ同期」ボタンをクリック
  - Convexデータベースにデータが保存されることを確認

- [ ] 差分更新
  - 再度同期を実行
  - 更新されたデータのみが同期されることを確認

### 5. パフォーマンステスト

- [ ] ページ読み込み時間（3秒以内）
- [ ] API応答時間（2秒以内）
- [ ] バッチ処理の動作確認

### 6. セキュリティテスト

- [ ] App Secretがクライアントサイドに露出していないことを確認
- [ ] トークンが暗号化されて保存されていることを確認
- [ ] HTTPSでの通信が行われていることを確認

## トラブルシューティング

### よくある問題と解決方法

#### 1. "Invalid OAuth 2.0 Access Token"エラー

**原因**: トークンの有効期限切れまたは無効なトークン

**解決方法**:

1. 新しいトークンを取得
2. 長期トークンに交換
3. システムユーザートークンの使用を検討

#### 2. "Application does not have permission"エラー

**原因**: 必要な権限が付与されていない

**解決方法**:

1. Facebook Business Managerで権限を確認
2. 必要な権限を追加：
   - ads_read
   - business_management
   - pages_read_engagement

#### 3. レート制限エラー

**原因**: API呼び出し回数が制限を超過

**解決方法**:

1. リクエスト間隔を調整
2. バッチAPIの使用
3. キャッシュの活用

## 実装済みの保護機能

1. **自動リトライ**
   - ネットワークエラー時に最大3回リトライ
   - 指数バックオフによる待機時間調整

2. **レート制限対応**
   - API使用状況の監視
   - 自動的なリクエスト調整

3. **エラーハンドリング**
   - ユーザーフレンドリーなエラーメッセージ
   - 詳細なログ記録

4. **キャッシュ機能**
   - 頻繁にアクセスするデータのキャッシュ
   - TTLによる自動更新

## テスト完了基準

以下のすべてが確認できたら、本番環境へのデプロイ準備が完了です：

- [ ] すべての手動テストが成功
- [ ] エラーハンドリングが適切に機能
- [ ] パフォーマンスが基準を満たしている
- [ ] セキュリティ要件を満たしている
- [ ] 実際のデータでダッシュボードが正常に表示される

## 次のステップ

テストが完了したら、以下の手順で本番環境へデプロイします：

1. 本番用の環境変数を設定
2. システムユーザートークンの取得
3. 本番広告アカウントへの権限付与
4. デプロイの実行
