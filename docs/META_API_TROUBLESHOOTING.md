# Meta API トラブルシューティングガイド

## エラー：キャンペーンデータ/インサイトデータの取得に失敗しました

このエラーが発生する主な原因と解決方法を以下に示します。

## 1. よくあるエラーの原因と解決方法

### 原因1: アクセストークンの権限不足

**症状**:

- エラーコード: 190
- メッセージ: "Invalid OAuth access token" または "Permissions error"

**解決方法**:

1. Graph API Explorer (https://developers.facebook.com/tools/explorer/) にアクセス
2. 以下の権限すべてにチェックを入れる：
   - `ads_read`
   - `ads_management`
   - `business_management`
3. 「Generate Access Token」をクリックして新しいトークンを生成
4. 新しいトークンでアカウントを再接続

### 原因2: 広告アカウントIDの形式が間違っている

**症状**:

- エラーコード: 100
- メッセージ: "Invalid parameter" または "Unsupported get request"

**解決方法**:

- アカウントIDは数字のみを入力（例: 123456789012345）
- システムが自動的に`act_`プレフィックスを追加します
- ビジネスマネージャーで正しいアカウントIDを確認

### 原因3: アカウントへのアクセス権限がない

**症状**:

- エラーコード: 10
- メッセージ: "You do not have permission to access this account"

**解決方法**:

1. Meta Business Manager にログイン
2. 「設定」→「ユーザー」→「アカウント」を確認
3. 対象の広告アカウントへのアクセス権限があることを確認
4. 権限がない場合は、管理者に権限付与を依頼

### 原因4: アクセストークンの有効期限切れ

**症状**:

- エラーコード: 190
- メッセージ: "Error validating access token"

**解決方法**:

- Graph API Explorerで新しいトークンを生成
- 長期トークンの使用を検討（60日間有効）

### 原因5: APIバージョンの非互換性

**症状**:

- エラーコード: 3
- メッセージ: "Unknown method"

**解決方法**:

- 最新のAPIバージョン（v18.0以上）を使用していることを確認
- 古いバージョンの機能は使用しない

## 2. デバッグ手順

### ステップ1: エラー詳細を確認

1. テスト画面で「エラー詳細を表示」をクリック
2. 以下の情報を確認：
   - リクエストURL
   - エラーレスポンス
   - エラーコード

### ステップ2: トークンの検証

```bash
# Graph API Explorerでトークンをデバッグ
https://developers.facebook.com/tools/debug/accesstoken/
```

1. アクセストークンを入力
2. 「Debug」をクリック
3. 以下を確認：
   - 有効期限
   - 権限リスト
   - アプリID

### ステップ3: 手動でAPIをテスト

Graph API Explorerで直接テスト：

```
GET /v18.0/act_{account_id}/campaigns
```

成功する場合は、システムの設定に問題がある可能性があります。

## 3. 具体的なエラー別対処法

### エラー: "(#100) param account_id must be a valid account ID"

- 原因: アカウントIDの形式が正しくない
- 対処:
  1. ビジネスマネージャーでアカウントIDを確認
  2. 数字のみを入力（act\_は不要）

### エラー: "(#200) Permissions error"

- 原因: 必要な権限が不足
- 対処:
  1. ads_read権限があることを確認
  2. ビジネスマネージャーでアカウントへのアクセス権を確認

### エラー: "(#17) User request limit reached"

- 原因: APIレート制限に達した
- 対処:
  1. 数分待ってから再試行
  2. バッチリクエストの使用を検討

### エラー: "Network Error" または "CORS Error"

- 原因: ネットワーク接続の問題
- 対処:
  1. インターネット接続を確認
  2. VPNを使用している場合は無効化
  3. ブラウザの拡張機能を無効化

## 4. それでも解決しない場合

### 確認事項チェックリスト

- [ ] アクセストークンは最新か？
- [ ] すべての必要な権限が付与されているか？
- [ ] アカウントIDは正しいか？
- [ ] ビジネスマネージャーでアカウントにアクセスできるか？
- [ ] APIの利用規約に同意しているか？

### 追加のデバッグ情報収集

1. **ブラウザのコンソールを確認**
   - F12キーを押してデベロッパーツールを開く
   - Consoleタブでエラーを確認
   - Networkタブで失敗したリクエストの詳細を確認

2. **cURLでテスト**

   ```bash
   curl -G \
     -d "access_token=YOUR_ACCESS_TOKEN" \
     "https://graph.facebook.com/v18.0/act_YOUR_ACCOUNT_ID/campaigns"
   ```

3. **Meta開発者サポート**
   - https://developers.facebook.com/support/
   - エラーコードと詳細を添えて問い合わせ

## 5. 予防策

1. **定期的なトークン更新**
   - 有効期限が近づいたら新しいトークンを生成
   - システムユーザーの使用を検討

2. **権限の定期確認**
   - ビジネスマネージャーで権限を定期的に確認
   - 必要最小限の権限のみを使用

3. **エラーログの保存**
   - エラーが発生したら詳細を記録
   - パターンを把握して事前に対処
